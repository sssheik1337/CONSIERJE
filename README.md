# CONSIERJE — логика бота и бизнес‑процессы

Этот документ описывает бизнес‑логику бота: подписки, доступ в канал, оплаты и админские сценарии. Технические детали эквайринга T‑Bank вынесены отдельно в `README_T-Bank.md`.

## 1) Основной сценарий для пользователя

1. Пользователь запускает бота и получает главное меню.
2. Если подписка активна — бот показывает дату окончания и даёт кнопку «Получить ссылку».
3. Если подписка неактивна — бот предлагает оплату (СБП или карта) и/или промокод.
4. После оплаты подписка продлевается, а доступ в канал выдаётся через одноразовую ссылку.

## 2) Подписка и доступ в канал

* **Одноразовые ссылки**: бот создаёт ссылку на вход в канал на 24 часа и с лимитом 1 участник. Это исключает повторное использование ссылки.
* **Проверка участия**: если пользователь уже в канале, ссылка не выдаётся.
* **Истечение подписки**: планировщик регулярно проверяет сроки и удаляет пользователей из канала, если подписка закончилась.

## 3) Оплата: два метода

### 3.1. СБП
* Пользователь выбирает СБП, получает QR или ссылку.
* После подтверждения оплаты подписка продлевается.
* Для автопродления используется **AccountToken**, который приходит в webhook и сохраняется у пользователя.

### 3.2. Карта
* Пользователь выбирает оплату картой и получает ссылку на платёжную форму T‑Bank.
* После подтверждения оплаты подписка продлевается.
* Для автопродления используется **RebillId** и **CustomerKey**, которые приходят в webhook и сохраняются у пользователя.

## 4) Рекуррентные платежи (автопродление)

### 4.1. СБП (AccountToken)
* При наличии `AccountToken` и включённом автопродлении бот делает списание через T‑Bank.
* При успехе подписка продлевается, при неуспехе автопродление отключается.

### 4.2. Карта (RebillId + CustomerKey)
* При наличии `RebillId` и включённом автопродлении бот инициирует рекуррентный платёж.
* Если платеж подтверждён — подписка продлевается.
* Если платёж отклонён — автопродление выключается и пользователь уведомляется.

## 5) Админ‑сценарии

* **Привязка канала**: администратор может привязать канал/группу через админ‑панель.
* **Права бота**: есть диагностика прав (пригласительные ссылки, бан пользователей).
* **Рассылка постов**: администратор может опубликовать пост с MarkdownV2, рассылка идёт последовательно, чтобы не перегружать Telegram API.
* **Ссылки на документы**: администратор может менять ссылки на политику, оферту и согласия через админ‑панель.

## 6) Где смотреть технические детали T‑Bank

* Детали эквайринга, подписи и webhook‑алгоритм — в `README_T-Bank.md`.
